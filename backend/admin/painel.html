<script>
  const API = location.origin; // mesmo host do backend/render
  let ADMIN_TOKEN = localStorage.getItem('x-admin-token') || '';

  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));

  const els = {
    kpis: {
      total: qs('#kpiInscritos'),
      quitados: qs('#kpiQuitados'),
      pendentes: qs('#kpiPendentes'),
      leads: qs('#kpiLeads'),
      leadsHoje: qs('#kpiLeadsHoje')
    },
    exportIns: qs('#btnExportInscritos'),
    exportLeads: qs('#btnExportLeads'),
    inpQ: qs('#inpQ'),
    selStatus: qs('#selStatus'),
    btnFiltrar: qs('#btnFiltrar'),
    inpToken: qs('#inpToken'),
    btnSalvarToken: qs('#btnSalvarToken'),
    tb: qs('#tbInscritos'),
    prev: qs('#prevPage'),
    next: qs('#nextPage'),
    info: qs('#pageInfo'),

    drawer: qs('#drawer'),
    btnCloseDrawer: qs('#btnCloseDrawer'),
    dId: qs('#dId'),
    dMeta: qs('#dMeta'),
    frmEdit: qs('#frmEdit'),
    btnCancelar: qs('#btnCancelar'),
    btnRestaurar: qs('#btnRestaurar'),

    modal: qs('#modal'),
    txtReason: qs('#txtReason'),
    btnConfirmCancel: qs('#btnConfirmCancel'),
    btnCancelModal: qs('#btnCancelModal')
  };

  let state = { page:1, size:20, q:'', status:'', totalPages:1, currentDetail:null };

  function authHeaders(extra={}) {
    return {
      'x-admin-token': ADMIN_TOKEN,
      'Content-Type': 'application/json',
      ...extra
    };
  }

  async function fetchJSON(url, opts={}) {
    const r = await fetch(url, opts);
    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch { j = { raw:t } }
    if (!r.ok) throw Object.assign(new Error(j?.error || r.status), {status:r.status, body:j});
    return j;
  }

  async function loadOverview() {
    const j = await fetchJSON(`${API}/api/admin/overview`, { headers:authHeaders() });
    els.kpis.total.textContent = j.inscritos_total;
    els.kpis.quitados.textContent = j.inscritos_quitados;
    els.kpis.pendentes.textContent = j.inscritos_pendentes;
    els.kpis.leads.textContent = j.leads_total;
    els.kpis.leadsHoje.textContent = j.leads_hoje;
  }

  async function loadInscritos() {
    const params = new URLSearchParams({
      page: state.page, size: state.size,
      ...(state.q ? {q: state.q} : {}),
      ...(state.status ? {status: state.status} : {})
    });
    const j = await fetchJSON(`${API}/api/admin/inscritos/list?`+params.toString(), { headers:authHeaders() });
    renderTable(j.items || []);
    els.info.textContent = `Página ${j.page}`;
    state.totalPages = (j.items?.length === state.size) ? state.page+1 : state.page;
  }

  function renderTable(items) {
    if (!items.length) { els.tb.innerHTML = '<tr><td colspan="8">Sem resultados</td></tr>'; return; }
    els.tb.innerHTML = items.map(r => {
      const created = r.criado_em ? new Date(r.criado_em).toLocaleString('pt-BR') : '';
      const badge = statusBadge(r.status);
      return `
        <tr data-id="${r.id}">
          <td>#${r.id}</td>
          <td>${escapeHtml(r.nome || '')}</td>
          <td>${escapeHtml(r.email || '')}</td>
          <td>${escapeHtml(r.telefone || '')}</td>
          <td>${badge}</td>
          <td>${(r.forma_pagamento || '—').toUpperCase()}</td>
          <td>${created}</td>
          <td>
            <button class="btn ghost" data-act="detalhe">Detalhes</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function statusBadge(s='') {
    const sx = (s || '').toLowerCase();
    let c = ''; if (sx==='quitado') c='ok'; else if (sx==='cancelado') c='danger'; else c='warn';
    return `<span class="kpi-value ${c}" style="font-size:12px">${escapeHtml(s || '—')}</span>`;
  }

  // Corrigido: escapar adequadamente &, <, >
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }

  // Drawer
  async function openDetail(id) {
    const j = await fetchJSON(`${API}/api/admin/inscritos/${id}`, { headers:authHeaders() });
    state.currentDetail = j.item;
    els.dId.textContent = `#${j.item.id}`;
    // Preenche form
    const f = els.frmEdit;
    f.nome.value = j.item.nome || '';
    f.email.value = j.item.email || '';
    f.telefone.value = j.item.telefone || '';
    f.frequentaPV.value = j.item.frequentaPV || '';
    f.campus.value = j.item.campus || '';
    f.forma_pagamento.value = j.item.forma_pagamento || '';
    f.nascimento.value = j.item.nascimento || '';

    const meta = [];
    if (j.item.status) meta.push(`Status: ${escapeHtml(j.item.status)}`);
    if (j.item.criado_em) meta.push(`Criado: ${new Date(j.item.criado_em).toLocaleString('pt-BR')}`);
    if (j.item.updated_at) meta.push(`Atualizado: ${new Date(j.item.updated_at).toLocaleString('pt-BR')}`);
    if (j.item.canceled_at) meta.push(`Cancelado: ${new Date(j.item.canceled_at).toLocaleString('pt-BR')}`);
    if (j.item.cancel_reason) meta.push(`Motivo: ${escapeHtml(j.item.cancel_reason)}`);
    els.dMeta.innerHTML = meta.join('<br/>');

    const isCanceled = (j.item.status || '').toLowerCase() === 'cancelado';
    els.btnCancelar.disabled = isCanceled;
    els.btnRestaurar.disabled = !isCanceled;

    els.drawer.classList.remove('hidden');
  }
  function closeDetail() {
    els.drawer.classList.add('hidden');
    state.currentDetail = null;
  }

  // UI Events
  els.btnSalvarToken.addEventListener('click', () => {
    const v = els.inpToken.value.trim();
    if (!v) return alert('Informe o x-admin-token');
    ADMIN_TOKEN = v;
    localStorage.setItem('x-admin-token', v);
    bootstrap();
  });
  els.btnFiltrar.addEventListener('click', () => {
    state.q = els.inpQ.value.trim();
    state.status = els.selStatus.value.trim();
    state.page = 1;
    loadInscritos().catch(handleAuthError);
  });
  els.prev.addEventListener('click', () => { if (state.page>1) { state.page--; loadInscritos().catch(handleAuthError); }});
  els.next.addEventListener('click', () => { state.page++; loadInscritos().catch(handleAuthError); });

  els.exportIns.addEventListener('click', () => window.open(`${API}/api/admin/export/inscritos.csv?token=${encodeURIComponent(ADMIN_TOKEN)}`,'_blank'));
  els.exportLeads.addEventListener('click', () => window.open(`${API}/api/admin/export/leads.csv?token=${encodeURIComponent(ADMIN_TOKEN)}`,'_blank'));

  els.tb.addEventListener('click', (ev) => {
    const btn = ev.target.closest('button[data-act]');
    if (!btn) return;
    const tr = ev.target.closest('tr'); const id = tr?.dataset?.id;
    if (!id) return;
    if (btn.dataset.act === 'detalhe') openDetail(id).catch(handleAuthError);
  });

  // Drawer ações
  els.btnCloseDrawer.addEventListener('click', closeDetail);

  els.frmEdit.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    if (!state.currentDetail) return;
    const fd = new FormData(els.frmEdit);
    const payload = Object.fromEntries(fd.entries());
    try {
      await fetchJSON(`${API}/api/admin/inscritos/${state.currentDetail.id}`, {
        method:'PUT',
        headers:authHeaders(),
        body: JSON.stringify(payload)
      });
      toast('Alterações salvas');
      loadInscritos().catch(()=>{});
    } catch(e){ handleAuthError(e); }
  });

  let cancelPending = null;
  els.btnCancelar.addEventListener('click', () => {
    els.modal.classList.remove('hidden');
    cancelPending = true;
  });
  els.btnCancelModal.addEventListener('click', () => {
    els.modal.classList.add('hidden');
    cancelPending = null;
  });
  els.btnConfirmCancel.addEventListener('click', async () => {
    if (!state.currentDetail) return;
    const reason = els.txtReason.value.trim();
    try {
      await fetchJSON(`${API}/api/admin/inscritos/${state.currentDetail.id}/cancel`, {
        method:'POST',
        headers:authHeaders(),
        body: JSON.stringify({ reason })
      });
      toast('Inscrição cancelada');
      els.modal.classList.add('hidden');
      closeDetail();
      loadInscritos().catch(()=>{});
    } catch(e){ handleAuthError(e); }
  });

  els.btnRestaurar.addEventListener('click', async () => {
    if (!state.currentDetail) return;
    try {
      await fetchJSON(`${API}/api/admin/inscritos/${state.currentDetail.id}/restore`, {
        method:'POST',
        headers:authHeaders(),
        body: JSON.stringify({ status: 'pendente_pagamento' })
      });
      toast('Inscrição restaurada');
      closeDetail();
      loadInscritos().catch(()=>{});
    } catch(e){ handleAuthError(e); }
  });

  // SSE tempo real
  function startSSE() {
    if (!ADMIN_TOKEN) return;
    const url = `${API}/api/admin/events?token=${encodeURIComponent(ADMIN_TOKEN)}`;
    const ev = new EventSource(url);
    ev.addEventListener('message', (m) => {
      try {
        const data = JSON.parse(m.data);
        if (data?.type === 'inscrito:new') {
          loadOverview().catch(()=>{});
          loadInscritos().catch(()=>{});
          toast(`Novo inscrito: ${data?.payload?.nome || '#'+data?.payload?.id}`);
        } else if (data?.type === 'inscrito:update') {
          loadOverview().catch(()=>{});
          loadInscritos().catch(()=>{});
        } else if (data?.type === 'lead:new') {
          loadOverview().catch(()=>{});
        }
      } catch {}
    });
  }

  function handleAuthError(e) {
    if (e?.status === 401 || e?.status === 503) {
      alert('Token inválido ou não configurado. Informe o x-admin-token.');
    } else {
      console.error(e);
      alert('Falha na operação.');
    }
  }

  // toasts simples
  function toast(msg) {
    const d = document.createElement('div');
    d.textContent = msg;
    d.style.position='fixed'; d.style.right='12px'; d.style.bottom='12px';
    d.style.background='rgba(0,0,0,.7)'; d.style.padding='8px 10px';
    d.style.borderRadius='8px'; d.style.fontSize='13px'; d.style.zIndex='9999';
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 2000);
  }

  async function bootstrap() {
    if (ADMIN_TOKEN) els.inpToken.value = ADMIN_TOKEN;
    await loadOverview().catch(handleAuthError);
    await loadInscritos().catch(handleAuthError);
    startSSE();
  }

  bootstrap();
</script>