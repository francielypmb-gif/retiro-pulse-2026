<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Admin — Retiro 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root{
    --bg:#0b0b0b; --card:#141414; --muted:#9aa0a6; --line:#242424;
    --azul:#16D2F2; --verde:#2ecc71; --amarelo:#f1c40f; --vermelho:#e74c3c;
  }
  *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
  body{background:#000;color:#fff;margin:0;padding:20px}
  .wrap{max-width:1200px;margin:0 auto}
  h1{margin:0 0 14px;color:var(--azul);font-size:22px}
  .bar{display:grid;grid-template-columns:1fr auto auto;gap:12px;margin-bottom:12px}
  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  .card{background:var(--card);border:1px solid var(--line);padding:12px;border-radius:10px}
  .card strong{display:block;font-size:20px;margin-top:2px}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{height:40px;border-radius:8px;border:1px solid var(--line);background:#111;color:#fff;padding:0 12px}
  button.primary{background:linear-gradient(90deg,#E6001D,#16D2F2);border:none;font-weight:bold}
  table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--line)}
  th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
  thead th{background:#111}
  .status{padding:4px 8px;border-radius:20px;font-size:12px}
  .s-pendente{background:#333;color:#ddd}
  .s-parcial{background:#312b00;color:#f1c40f}
  .s-quitado{background:#0d2b1b;color:#2ecc71}
  .s-cancelado{background:#2b0d0d;color:#e74c3c}
  .chip{padding:4px 8px;border:1px solid var(--line);border-radius:12px;font-size:12px;background:#101010}
  .btn{height:32px;padding:0 10px;border-radius:6px;border:1px solid var(--line);background:#151515;color:#fff;cursor:pointer}
  .btn.ok{background:#0f512f;border-color:#0f512f}
  .btn.warn{background:#513f0f;border-color:#513f0f}
  .btn.danger{background:#512f2f;border-color:#512f2f}
  .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:9999}
  .modal .box{width:92%;max-width:520px;background:#141414;border:1px solid #242424;border-radius:12px;padding:14px}
  .link{color:#16D2F2;text-decoration:underline;cursor:pointer}
</style>
</head>

<body>

<div class="wrap">
  <h1>Admin — Retiro 2026</h1>

  <div class="cards">
    <div class="card"><span>Inscritos</span><strong id="kInscritos">—</strong></div>
    <div class="card"><span>Quitados</span><strong id="kQuitados">—</strong></div>
    <div class="card"><span>Pendentes</span><strong id="kNaoQuitados">—</strong></div>
    <div class="card"><span>Vagas restantes</span><strong id="kVagas">—</strong></div>
  </div>

  <div class="bar card">
    <div class="filters">
      <input id="q" placeholder="Buscar nome, CPF ou email">
      <select id="fCampus">
        <option value="">Todos campus</option>
        <option>Antônio Carlos</option>
        <option>Ingleses</option>
        <option>Rio Vermelho</option>
        <option>Sede</option>
        <option>Visitante</option>
      </select>
      <select id="fStatus">
        <option value="">Todos status</option>
        <option value="pendente_pagamento">Pendente de pagamento</option>
        <option value="pendente">Pendente</option>
        <option value="parcial">Parcial</option>
        <option value="quitado">Quitado</option>
        <option value="cancelado">Cancelado</option>
      </select>
      <!-- novo filtro de forma de pagamento -->
      <select id="fPagamento">
        <option value="">Todas formas</option>
        <option value="pix">Pix</option>
        <option value="boleto">Boleto</option>
        <option value="cartao">Cartão</option>
      </select>
    </div>
    <button id="btnReload">Recarregar</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>CPF</th>
        <th>Email</th>
        <th>Campus</th>
        <th>Forma pgto.</th>
        <th>Status</th>
        <th>Parcelas</th>
        <th>Check-in</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<div id="modal" class="modal">
  <div class="box">
    <h3>Parcelas</h3>
    <div id="mBody">Carregando...</div>
    <button onclick="closeModal()">Fechar</button>
  </div>
</div>

<script>
const BASE = 'https://retiro-pulse-2026-backend.onrender.com';

let cache = [];

function badge(status){
  const s = String(status || '').toLowerCase();
  const map = {
    'pendente': 's-pendente',
    'pendente_pagamento': 's-pendente',
    'parcial': 's-parcial',
    'quitado': 's-quitado',
    'cancelado': 's-cancelado'
  };
  const label = {
    'pendente': 'Pendente',
    'pendente_pagamento': 'Pendente pgto.',
    'parcial': 'Parcial',
    'quitado': 'Quitado',
    'cancelado': 'Cancelado'
  };
  const cls = map[s] || 's-pendente';
  const txt = label[s] || s || '-';
  return `<span class="status ${cls}">${txt}</span>`;
}

function filtro(p){
  const q = document.getElementById('q').value.toLowerCase();
  const c = document.getElementById('fCampus').value;
  const s = document.getElementById('fStatus').value;
  const f = document.getElementById('fPagamento').value;

  const hitQ = (!q || [p.nome,p.email,p.cpf].join().toLowerCase().includes(q));
  const hitC = (!c || p.campus === c);
  const hitS = (!s || String(p.status).toLowerCase() === s);
  const hitF = (!f || String(p.forma_pagamento||'').toLowerCase() === f);

  return hitQ && hitC && hitS && hitF;
}

function render(lista){
  const el = document.getElementById('lista');
  el.innerHTML = '';

  lista.forEach(p=>{
    const formaChip = p.forma_pagamento
      ? `<span class="chip">${String(p.forma_pagamento).toUpperCase()}</span>`
      : '<span class="chip" style="opacity:.6">—</span>';

    el.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${p.id}</td>
        <td>${p.nome}</td>
        <td>${p.cpf}</td>
        <td>${p.email}</td>
        <td>${p.campus || '-'}</td>
        <td>${formaChip}</td>
        <td>${badge(p.status)}</td>
        <td><span class="link" onclick="viewInstallments(${p.id})">ver</span></td>
        <td>${p.checkin ? '✅' : '-'}</td>
        <td>
          <button class="btn ok" onclick="setStatus(${p.id},'quitado')">Quitado</button>
          <button class="btn warn" onclick="setCheckin(${p.id},1)">Check-in</button>
          <button class="btn danger" onclick="cancelEntry(${p.id})">Cancelar</button>
        </td>
      </tr>
    `);
  });

  document.getElementById('kInscritos').textContent = cache.length;
  document.getElementById('kQuitados').textContent = cache.filter(x=>String(x.status).toLowerCase()==='quitado').length;
  document.getElementById('kNaoQuitados').textContent = cache.filter(x=>String(x.status).toLowerCase()!=='quitado').length;
}

async function loadAll(){
  try{
    const r = await fetch(`${BASE}/admin/inscritos`);
    if(!r.ok) throw new Error(await r.text());
    cache = await r.json();
    render(cache.filter(filtro));
    await loadSeats();
  }catch(e){
    alert('Erro ao carregar inscritos');
  }
}

async function loadSeats(){
  try{
    const r = await fetch(`${BASE}/vagas`);
    if(!r.ok) throw new Error();
    const j = await r.json();
    document.getElementById('kVagas').textContent = j.restantes;
  }catch{}
}

async function setStatus(id,status){
  await fetch(`${BASE}/admin/status/${id}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({status})
  });
  loadAll();
}

async function setCheckin(id,value){
  await fetch(`${BASE}/admin/checkin/${id}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({value})
  });
  loadAll();
}

async function cancelEntry(id){
  if(!confirm('Deseja cancelar esta inscrição?')) return;
  await fetch(`${BASE}/admin/cancelar/${id}`,{ method:'POST' });
  loadAll();
}

function closeModal(){
  document.getElementById('modal').style.display = 'none';
}

async function viewInstallments(id){
  const modal = document.getElementById('modal');
  const body = document.getElementById('mBody');
  modal.style.display = 'flex';

  try{
    const r = await fetch(`${BASE}/admin/parcelas/${id}`);
    const list = await r.json();

    if (!list || !list.length) {
      body.innerHTML = '<span style="color:#9aa0a6">Nenhuma parcela registrada ainda.</span>';
      return;
    

    body.innerHTML = list.map(p=>`
      Parcela ${p.parcela} — R$ ${Number(p.valor||0).toFixed(2)} — ${p.status}
      ${p.boleto_url ? ` — <a href="${p.boleto_url}" target="_blank" class="link">boleto</a>` : ''}
    `).join('<br>');
  }catch(e){
    body.innerHTML = '<span style="color:#e74c3c">Erro ao carregar parcelas.</span>';
  }
}

['q','fCampus','fStatus','fPagamento'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>render(cache.filter(filtro)));
});

document.getElementById('btnReload').onclick = loadAll;

loadAll();
</script>

</body>
</html>