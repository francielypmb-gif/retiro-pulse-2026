<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Retiro 2026 ‚Äî At√© Quando?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- FAVICON -->
  <link rel="icon" href="./assets/logo-pv.png" type="image/png" />
  <link rel="apple-touch-icon" href="./assets/logo-pv.png" />

  <link rel="stylesheet" href="./css/style.css" />
</head>

<body>

  <div class="container">

    <!-- LOGO / BANNER -->
    <div class="logos">
      <img src="./assets/id-pulse.PNG" alt="Identidade do Retiro" />
    </div>

    <!-- T√çTULO -->
    <h1>RETIRO 2026<br/>AT√â QUANDO?</h1>

    <!-- SUBT√çTULO -->
    <p class="sub">
      ‚Ä¢ Dias 03 a 05 de Abril ‚Ä¢ Palho√ßa - SC<br>
      ‚Ä¢ Valor: <strong>R$ 320,00</strong>
    </p>

    <!-- TIMER -->
    <div id="timer" class="timer">
      <div><span id="dias">00</span><small>Dias</small></div>
      <div><span id="horas">00</span><small>Horas</small></div>
      <div><span id="minutos">00</span><small>Min</small></div>
      <div><span id="segundos">00</span><small>Seg</small></div>
    </div>

    <!-- CONTADOR DE VAGAS -->
    <p id="vagas" class="sub">Vagas dispon√≠veis: <strong>--</strong></p>

    <!-- FORMUL√ÅRIO -->
    <form id="formInscricao" autocomplete="on">
      <input type="text" placeholder="Nome completo" id="nome" required />
      <input type="text" placeholder="CPF" id="cpf" required />

      <!-- ====== DATA DE NASCIMENTO ====== -->
      <input
        type="text"
        id="nascimento_display"
        name="nascimento_display"
        placeholder="Data de nascimento"
        autocomplete="bday"
        required
      />
      <input type="hidden" id="nascimento" name="nascimento" />
      <!-- ====== FIM ====== -->

      <input type="email" placeholder="Email" id="email" required />
      <input type="tel" placeholder="Telefone" id="telefone" required />

      <!-- Frequento a Palavra Viva? -->
      <select id="frequentaPV" required>
        <option value="" disabled selected>Frequento a Palavra Viva?</option>
        <option value="Sim">Sim</option>
        <option value="N√£o">N√£o</option>
        <option value="Visitante">Visitante</option>
      </select>

      <!-- Campus (s√≥ aparece quando "Sim") -->
      <div id="wrapCampus" style="display:none;">
        <select id="campus">
          <option value="" disabled selected>Qual Palavra Viva?</option>
          <option value="Ant√¥nio Carlos">Ant√¥nio Carlos</option>
          <option value="Ingleses">Ingleses</option>
          <option value="Rio Vermelho">Rio Vermelho</option>
          <option value="Sede">Sede</option>
        </select>
      </div>

      <!-- Forma de pagamento -->
      <select id="formaPagamento" required>
        <option value="" disabled selected>Forma de pagamento</option>
        <option value="pix">Pix √† vista</option>
        <option value="boleto">Boleto</option>
        <option value="cartao">Cart√£o de cr√©dito</option>
      </select>

      <!-- Quantidade de parcelas (s√≥ quando "boleto") -->
      <div id="wrapParcelas" style="display:none; margin-top:8px;">
        <select id="qtdParcelas">
          <option value="3" selected>3 parcelas</option>
          <option value="2">2 parcelas</option>
          <option value="1">1 parcela (boleto √† vista)</option>
        </select>
        <small class="muted" style="display:block;margin-top:4px;color:#9aa0a6">
          A √∫ltima parcela vence em 01/04/2026. As anteriores s√£o ajustadas automaticamente.
        </small>
      </div>

      <!-- ======= DATAS ESCOLHIDAS PARA BOLETO (oculto por enquanto) ======= -->
      <div id="wrapDatasBoleto" style="display:none; margin-top:8px;">
        <div id="linhaDataP1" style="margin-bottom:6px;">
          <label for="dataParcela1" style="display:block; font-size:12px; color:#9aa0a6; margin-bottom:4px;">
            Data da 1¬™ parcela (Fev/Mar)
          </label>
          <input type="date" id="dataParcela1" />
        </div>

        <div id="linhaDataP2" style="margin-bottom:6px;">
          <label for="dataParcela2" style="display:block; font-size:12px; color:#9aa0a6; margin-bottom:4px;">
            Data da 2¬™ parcela (Mar)
          </label>
          <input type="date" id="dataParcela2" />
        </div>

        <small style="display:block; color:#9aa0a6;">
          ‚Ä¢ A √∫ltima parcela vence em <strong>01/04/2026</strong> (fixa).<br/>
          ‚Ä¢ As datas escolhidas n√£o podem ser no passado.
        </small>
      </div>
      <!-- ======= FIM BLOCO ======= -->

      <button type="submit">FINALIZAR INSCRI√á√ÉO</button>
    </form>

    <!-- FORMAS DE PAGAMENTO -->
    <div class="footer">
      ‚úî Pix √† vista<br>
      ‚úî Cart√£o com acr√©scimo da maquininha<br>
      ‚úî Boleto (1x/2x/3x) ‚Äî <u>quita√ß√£o at√© 01/04/2026</u>
    </div>

  </div>

  <!-- === CONFIG / UI === -->
  <script>
    // USE SEMPRE HTTPS do Render (evita Mixed Content)
    const API = 'https://retiro-pulse-2026-backend.onrender.com';

    // üîî Envia notifica√ß√£o (admin + inscrito) via /api/leads
    async function enviarLeadNotificacao({ name, email, phone, source = 'landing' }) {
      try {
        const res = await fetch(`${API}/api/leads`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone, source })
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json.ok) {
          console.warn('[LEAD] falha ao notificar:', json?.error || res.status);
        } else {
          console.log('[LEAD] notifica√ß√£o enviada:', json.lead?.id);
        }
      } catch (e) {
        console.warn('[LEAD] erro ao notificar (ignorado):', e?.message || e);
      }
    }

    const frequentaPV   = document.getElementById('frequentaPV');
    const wrapCampus    = document.getElementById('wrapCampus');
    const campus        = document.getElementById('campus');

    const formaPagamento = document.getElementById('formaPagamento');
    const wrapParcelas   = document.getElementById('wrapParcelas');
    const qtdParcelas    = document.getElementById('qtdParcelas');

    frequentaPV.addEventListener('change', () => {
      const v = frequentaPV.value;
      if (v === 'Sim') {
        wrapCampus.style.display = 'block';
        campus.setAttribute('required', 'required');
      } else {
        wrapCampus.style.display = 'none';
        campus.removeAttribute('required');
        campus.value = '';
      }
    });

    // Mant√©m exibi√ß√£o de parcelas s√≥ quando "boleto"
    formaPagamento.addEventListener('change', () => {
      wrapParcelas.style.display = (formaPagamento.value === 'boleto') ? 'block' : 'none';
      atualizarDatasUI();
    });
  </script>

  <!-- === Valida√ß√£o de CPF (front) === -->
  <script>
    function cpfValido(cpf) {
      const s = (cpf || '').replace(/\D/g, '');
      if (!/^\d{11}$/.test(s)) return false;
      if (/^(\d)\1{10}$/.test(s)) return false;
      let soma = 0, resto;
      for (let i = 1; i <= 9; i++) soma += parseInt(s.substring(i-1,i)) * (11 - i);
      resto = (soma * 10) % 11; if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(s.substring(9,10))) return false;
      soma = 0;
      for (let i = 1; i <= 10; i++) soma += parseInt(s.substring(i-1,i)) * (12 - i);
      resto = (soma * 10) % 11; if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(s.substring(10,11));
    }
  </script>

  <!-- === SUBMIT: CRIA INSCRI√á√ÉO === -->
  <script>
    const form = document.getElementById("formInscricao");

    // Datas de boleto (mantidas, mas ocultas por enquanto)
    const wrapDatasBoleto = document.getElementById('wrapDatasBoleto');
    const linhaDataP1     = document.getElementById('linhaDataP1');
    const linhaDataP2     = document.getElementById('linhaDataP2');
    const dataParcela1    = document.getElementById('dataParcela1');
    const dataParcela2    = document.getElementById('dataParcela2');

    function hojeMais(dias) {
      const d = new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() + dias);
      return d.toISOString().slice(0,10);
    }
    const LIMITE_ULTIMA = '2026-04-01';
    const MIN_DATAS     = hojeMais(2);

    function aplicarLimitesDatas() {
      [dataParcela1, dataParcela2].forEach(inp => {
        if (!inp) return;
        inp.min = MIN_DATAS;
        inp.max = LIMITE_ULTIMA;
      });
    }
    aplicarLimitesDatas();

    function atualizarDatasUI() {
      wrapDatasBoleto.style.display = 'none';
      dataParcela1.value = '';
      dataParcela2.value = '';
    }

    qtdParcelas.addEventListener('change', atualizarDatasUI);
    atualizarDatasUI();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const freq  = document.getElementById('frequentaPV').value;
      const camp  = document.getElementById('campus') ? document.getElementById('campus').value : null;
      const forma = document.getElementById('formaPagamento').value;

      let campusFinal = null;
      if (freq === 'Sim')       campusFinal = camp || null;
      if (freq === 'Visitante') campusFinal = 'Visitante';

      const dados = {
        nome: document.getElementById('nome').value.trim(),
        cpf: document.getElementById('cpf').value.trim(),
        nascimento: document.getElementById('nascimento').value,
        email: document.getElementById('email').value.trim(),
        telefone: document.getElementById('telefone').value.trim(),
        frequentaPV: freq,
        campus: campusFinal,
        formaPagamento: forma
      };

      const botao = form.querySelector('button[type="submit"]');
      const prev  = botao.innerText;
      botao.disabled = true;
      botao.innerText = 'Enviando...';

      try {
        if (!cpfValido(dados.cpf)) {
          alert('CPF inv√°lido. Verifique e tente novamente.');
          botao.disabled = false;
          botao.innerText = prev;
          return;
        }

        // 1) Cria inscri√ß√£o (sem chamar pagamentos)
        const res = await fetch(`${API}/inscricao`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados)
        });

        const inscText = await res.text();

        if (res.status === 409) {
          let t; try { t = JSON.parse(inscText); } catch { t = {erro:'CPF duplicado'}; }
          alert(t.erro || "J√° existe uma inscri√ß√£o para este CPF.");
          return;
        }
        if (res.status === 403) {
          let t; try { t = JSON.parse(inscText); } catch { t = {erro:'Inscri√ß√µes encerradas'}; }
          alert(t.erro || "Inscri√ß√µes encerradas.");
          encerrarInscricoes();
          return;
        }
        if (res.status === 400) {
          let t; try { t = JSON.parse(inscText); } catch { t = {erro:'Dados inv√°lidos. Confira os campos.'}; }
          alert(t.erro || 'Dados inv√°lidos. Confira os campos.');
          return;
        }
        if (!res.ok) {
          alert(`Falha /inscricao (${res.status}): ${inscText.slice(0, 300)}`);
          return;
        }

        // 2) UX para o usu√°rio
        const formaHumana =
          (forma === 'pix') ? 'Pix' :
          (forma === 'boleto') ? 'Boleto' : 'Cart√£o';
        alert(
          "Inscri√ß√£o realizada com sucesso!\n\n" +
          `Voc√™ escolheu pagar via ${formaHumana}.\n` +
          "Enviaremos as instru√ß√µes de pagamento por e‚Äëmail/WhatsApp em breve."
        );

        // 3) üîî Dispara notifica√ß√£o (admin + inscrito) ‚Äî n√£o bloqueia
        enviarLeadNotificacao({
          name: document.getElementById('nome').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('telefone').value.trim(),
          source: 'landing'
        });

        // Limpa UI
        form.reset();
        wrapCampus.style.display = 'none';
        campus.removeAttribute('required');
        wrapParcelas.style.display = 'none';
        wrapDatasBoleto.style.display = 'none';
        carregarVagas();

      } catch (err) {
        console.error('Catch geral:', err);
        alert("Erro real (catch): " + (err?.message || 'Falha desconhecida'));
      } finally {
        botao.disabled = false;
        botao.innerText = prev;
      }
    });
  </script>

  <!-- === TIMER === -->
  <script>
    // At√© 03/04/2026 18:00 (America/Sao_Paulo)
    const alvo = new Date("2026-04-03T18:00:00-03:00").getTime();

    setInterval(() => {
      const agora = Date.now();
      const diff = Math.max(0, alvo - agora);

      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const m = Math.floor((diff / (1000 * 60)) % 60);
      const s = Math.floor((diff / 1000) % 60);

      const elDias = document.getElementById('dias');
      const elHoras = document.getElementById('horas');
      const elMin = document.getElementById('minutos');
      const elSeg = document.getElementById('segundos');

      if (!elDias || !elHoras || !elMin || !elSeg) return;

      elDias.textContent = String(d).padStart(2, '0');
      elHoras.textContent = String(h).padStart(2, '0');
      const pad = x => String(x).padStart(2, '0');
      elMin.textContent = pad(m);
      elSeg.textContent = pad(s);
    }, 1000);
  </script>

  <!-- === VAGAS === -->
  <script>
    async function carregarVagas() {
      try {
        const res = await fetch(`${API}/vagas`);
        const { restantes } = await res.json();
        const alvo = document.querySelector('#vagas strong');
        if (alvo) alvo.textContent = restantes;
        if (restantes <= 0) encerrarInscricoes();
      } catch (e) {
        console.warn("N√£o foi poss√≠vel carregar vagas agora.");
      }
    }

    function encerrarInscricoes() {
      const form  = document.getElementById('formInscricao');
      const botao = form.querySelector('button[type="submit"]');
      form.querySelectorAll('input, select').forEach(i => i.disabled = true);
      botao.disabled = true;
      botao.style.filter = 'grayscale(0.9)';
      botao.style.cursor = 'not-allowed';
      const aviso = document.createElement('p');
      aviso.style.cssText = 'text-align:center;color:#ff6b6b;margin:12px 0;';
      aviso.textContent = 'Inscri√ß√µes encerradas ‚Äî vagas esgotadas.';
      form.insertAdjacentElement('beforebegin', aviso);
    }

    // Carrega ao abrir
    carregarVagas();
  </script>

  <!-- ===== MODAL PIX ===== -->
  <div id="pixModal" style="display:none; position:fixed; inset:0; background:#0009; z-index:9999; align-items:center; justify-content:center;">
    <div style="width:92%; max-width:420px; background:#141414; border:1px solid #242424; border-radius:12px; padding:18px;">
      <h3 style="margin:0 0 8px; color:#16D2F2; text-align:center;">Pix √† vista</h3>
      <p style="color:#bbb; font-size:14px; text-align:center; margin:0 0 12px;">
        Escaneie o QR Code abaixo ou copie o c√≥digo para pagar no seu banco.
      </p>
      <div id="pixQrWrap" style="display:flex; align-items:center; justify-content:center; background:#0e0e0e; border:1px solid #222; border-radius:8px; height:260px; margin-bottom:10px;">
        <img id="pixQrImg" src="" alt="QR Code Pix" style="max-width:240px; max-height:240px; display:none;"/>
        <div id="pixQrFallback" style="color:#777; font-size:13px; text-align:center; padding:10px;">
          QR Code n√£o dispon√≠vel. Use o bot√£o "Copiar c√≥digo".
        </div>
      </div>
      <textarea id="pixPayload" readonly style="width:100%; height:80px; background:#111; color:#fff; border:1px solid #333; border-radius:8px; padding:10px; font-size:12px; margin-bottom:10px;"></textarea>
      <div style="display:flex; gap:10px;">
        <button id="btnCopiarPix" style="flex:1; height:44px; border:none; border-radius:8px; background:#1f6feb; color:#fff; font-weight:bold; cursor:pointer;">Copiar c√≥digo</button>
        <button id="btnFecharPix" style="width:120px; height:44px; border:1px solid #333; border-radius:8px; background:#151515; color:#fff; cursor:pointer;">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    // Comportamento do modal PIX
    const pixModal       = document.getElementById('pixModal');
    const pixPayloadEl   = document.getElementById('pixPayload');
    const pixQrImg       = document.getElementById('pixQrImg');
    const pixQrFallback  = document.getElementById('pixQrFallback');
    const btnCopiarPix   = document.getElementById('btnCopiarPix');
    const btnFecharPix   = document.getElementById('btnFecharPix');

    btnFecharPix.addEventListener('click', () => { pixModal.style.display = 'none'; });
    btnCopiarPix.addEventListener('click', async () => {
      if (!pixPayloadEl.value) return;
      try {
        await navigator.clipboard.writeText(pixPayloadEl.value);
        btnCopiarPix.textContent = 'Copiado!';
        setTimeout(() => btnCopiarPix.textContent = 'Copiar c√≥digo', 1500);
      } catch {
        alert('N√£o foi poss√≠vel copiar. Selecione o c√≥digo e copie manualmente.');
      }
    });

    function abrirPixModal({ qrImageBase64, qrPayload }) {
      if (qrImageBase64) {
        pixQrImg.src = `data:image/png;base64,${qrImageBase64}`;
        pixQrImg.style.display = 'block';
        pixQrFallback.style.display = 'none';
      } else {
        pixQrImg.style.display = 'none';
        pixQrFallback.style.display = 'block';
      }
      pixPayloadEl.value = qrPayload || '';
      pixModal.style.display = 'flex';
    }
  </script>

  <!-- ===== SCRIPT DO CAMPO DE DATA ===== -->
  <script>
    (function () {
      const display = document.getElementById('nascimento_display');
      const hidden  = document.getElementById('nascimento');

      function isoToBr(iso) {
        if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
        const [y, m, d] = iso.split('-');
        return `${d}/${m}/${y}`;
      }

      function brToIso(br) {
        if (!br || !/^\d{2}\/\d{2}\/\d{4}$/.test(br)) return '';
        const [d, m, y] = br.split('/');
        return `${y}-${m}-${d}`;
      }

      display.addEventListener('focus', () => {
        display.type = 'date';
        if (hidden.value) display.value = hidden.value;
        if (typeof display.showPicker === 'function') {
          try { display.showPicker(); } catch(_) {}
        }
      });

      display.addEventListener('change', () => {
        if (display.type === 'date' && display.value) {
          hidden.value = display.value;           // ISO
          display.type = 'text';
          display.value = isoToBr(hidden.value);  // Mostra BR
        }
      });

      display.addEventListener('blur', () => {
        if (display.type === 'date') {
          if (!display.value) {
            display.type = 'text';
            display.value = '';
          } else {
            hidden.value = display.value;
            display.type = 'text';
            display.value = isoToBr(hidden.value);
          }
        } else {
          const iso = brToIso(display.value);
          if (iso) hidden.value = iso;
          else if (!display.value) hidden.value = '';
        }
      });

      const form = document.getElementById('formInscricao');
      if (form) {
        form.addEventListener('reset', () => {
          hidden.value = '';
          display.type = 'text';
          display.value = '';
        });
      }

      if (hidden.value) {
        display.value = isoToBr(hidden.value);
      }
    })();
  </script>

</body>
</html>